{% extends 'base.html.twig' %}

{% block title %}Message privée{% endblock %}

{% block body %}


<div class="grid-container.fluid">



	<div class="grid-x grid-padding-x menu">

		<div class="large-3 medium-3 cell">
			<h1>*Logo*</h1>
		</div>

		<div class="large-2 medium-2 cell">
			<input type="text" class="menu" placeholder="Chercher..." />
		</div>

		<div class="large-2 medium-2 cell lienAccueil">
			<a href="{{path('login')}}" class="menu">Accueil</a>
		</div>

		<div class="large-1 medium-1 cell">
		<a href="#">
			<img src="{{ asset('css/img/invitations.png')}}" class="menu" alt="Invitations" />
		</a>
		</div>

		<div class="large-1 medium-1 cell">
		<a href="">
			<img src="{{ asset('css/img/messages.png')}}" class="menu" alt="Messages"  />
		</a>
		</div>

		<div class="large-1 medium-1 cell">
			<a href="#">
			<img src="{{ asset('css/img/parametres.png')}}" class="menu" alt="Paramètres" />
			</a>
		</div>

		<div class="large-2 medium-2 cell">
			<a href="{{ path('logout') }}" class="menu">Déconnexion</a>
		</div>

	</div>

	<div class="grid-x grid-padding-x contenu">

		<div class="large-12 medium-12 cell">
			<h1>Messagerie privée</h1>
		</div>

	</div>

	<hr class="style">

	<div class="grid-x grid-padding-x contenu">

		<div id="msg" class="large-4 medium-4 cell msg">
			<h1>Conversations</h1>
			<h1>*Liste conversations*</h1>
		</div>

		<div id="msg" class="large-8 medium-8 cell msg">
			<h1>{{prenom_destinataire | raw}} {{nom_destinataire | raw}}</h1>

				<div class="tchat">
					<span class="tchat">

					{% for message in old_messages %}
        				<div id="pseudo"> {{message.nom_emmeteur | raw}} {{message.prenom_emmeteur | raw}}  | 	<span id="message"> {{message.texte}} </span>	</div>

					{% endfor %}

					<!--		<div id="pseudo"> prenom nom  | 	<span id="message"> message </span>	</div> -->


					</span>
				</div>

				<form name="message" action="{{path('message',{'id_destinataire': id_destinataire}) }}" method="post">
        			<input name="usermsg" type="text" id="usermsg"  placeholder="Saisissez votre message..." />
        			<input class="btn" name="envoyer" type="submit"  id="envoyer" value="Envoyer"/>
				</form>
		</div>

	</div>



		{# <input class="btnenv" name="o" type="submit"  id="o" value="Envoyer"/> #}






		<div class="grid-x grid-padding-x footer">
			<div class="large-12 medium-12 cell">
				<p class="footer">&copy; Aix-Marseille Université</p>
			</div>
		</div>


</div>
{% endblock %}

{% block javascripts %}

<script type="text/javascript">

var id_message = "{{id_message}}";
console.log(id_message);

	$('#envoyer').click(function(e){
		e.preventDefault();
		var pseudo ="{{prenom | raw}} {{nom | raw}} | "; // on sécurise les données
		var message = $('#usermsg').val();
		$.post("{{path('message',{'id_destinataire': id_destinataire})}}",
	     {
				 	method:"submit",
	         pseudo: pseudo,
	        message: message
	     },
	     function(data, status){
	         alert("Le message vient d'être envoyer sur la base " );
					 id_message =data.id_message;
	     });
	$('span.tchat').append("<div>"+pseudo+"<span>"+message+"</span>"+"</div>");
	});


	function charger(){
		setInterval(function(){
			$.ajax({
					url : "{{path('message',{'id_destinataire': id_destinataire})}}", // on passe l'id le plus récent au fichier de chargement
					type : "POST",
					data:"method=" + "getMessage" + "&id_message=" + id_message,
					success : function(data){
						if(!jQuery.isEmptyObject(data.message)){
					$('span.tchat').append('<div id="pseudo">'+"{{nom | raw}} {{prenom | raw}}  |"+	'<span id="message">'+data.message[0].texte+" </span>	</div>" );

			}


					}

			});
		}, 5000);
	}
charger();

</script>

{% endblock %}
